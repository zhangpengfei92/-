package com.jcl.controller;

import java.io.File;

import org.apache.commons.fileupload.disk.DiskFileItem;
import org.apache.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.multipart.commons.CommonsMultipartFile;

import com.jcl.comm.SerialNo;
import com.jcl.pojo.FileUploadPathObject;
import com.jcl.pojo.Subzh;
import com.jcl.service.SubzhService;
import com.jcl.util.DeployProperties;
import com.jcl.util.FileUtil;

/**
 * @author zhangyang 
 * 实名认证
 */
@RequestMapping("/auth")
@Controller
public class AuthController {
    private static Logger logger = Logger.getLogger(AuthController.class);
    @Autowired
    private SubzhService subzhService;

    @RequestMapping("/apply/{id}")
    public String auth(@PathVariable("id")String id, Model model) {
        Subzh subzh = subzhService.selectByPrimaryKey(id);
        model.addAttribute("subzh", subzh);
        return "auth/apply";
    }

    @RequestMapping(value = "/doAuth", produces = "text/plain;charset=utf-8")
    @ResponseBody
    public String doAuth(@RequestParam("frontFile") MultipartFile frontFile,
            @RequestParam("backFile") MultipartFile backFile, 
            @RequestParam("cardFile") MultipartFile cardFile,
            Subzh subzh) {
        String frontPic = getUpdateFilePath(frontFile);
        String backPic = getUpdateFilePath(backFile);
        String cardPic = getUpdateFilePath(cardFile);
        subzh.setFrontPic(frontPic);
        subzh.setBackPic(backPic);
        subzh.setCardPic(cardPic);
        String result = subzhService.auth(subzh);
        return result;
    }

    private String getUpdateFilePath(MultipartFile frontFile) {
        CommonsMultipartFile cmf = (CommonsMultipartFile) frontFile;
        DiskFileItem dfi = (DiskFileItem) cmf.getFileItem();
        File file = dfi.getStoreLocation();
        String fileName = SerialNo.getUNID() + ".jpg";
        FileUploadPathObject uploadPathObject = null;
        try {
            uploadPathObject = FileUtil.uploadProjectLocal("images", file, fileName);
        }
        catch (Exception e) {
            e.printStackTrace();
            logger.error("实名认证上传图片异常：" + e.getMessage());
        }
        logger.info("uploadPathObject:" + uploadPathObject);
        // 判断上传地址不为空
//        String filePath = "";
        if (uploadPathObject != null) {
            // 获取该地址信息
//            filePath = uploadPathObject.getAbsoluteFullPath();
//            filePath = uploadPathObject.getShortPath();
            String publicApachePath = DeployProperties.getInstance().getPublicApachePath();
            fileName = publicApachePath + fileName;
            return fileName;
        }
        return null;
    }
}
